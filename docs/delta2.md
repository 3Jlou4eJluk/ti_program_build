# delta2.md - Отладка библиотеки TI-Nspire

Дополнительные правила и найденные проблемы при разработке библиотеки leontief.

## Критическая проблема: конструкция If

### Почему не работало

**НЕПРАВИЛЬНЫЙ синтаксис** (функция не появлялась в библиотеке):
```
If s>=1
:Return 0
:EndIf
```

или

```
If s>1&#13;:Return 0&#13;:EndIf
```

При использовании такого синтаксиса библиотека собиралась без ошибок, но:
- Функция `is_productive` не появлялась в списке функций библиотеки
- Отображалась только функция `version()`
- Парсер TI-Nspire останавливался на синтаксической ошибке в `If`

### Почему заработало

**ПРАВИЛЬНЫЙ синтаксис** (обязательно `Then` после условия):
```
If s>=1 Then
:Return 0
:EndIf
```

или в XML-формате:

```
If s&gt;=1 Then&#13;:Return 0&#13;:EndIf
```

**Правило**: В TI-BASIC конструкция `If` ВСЕГДА требует ключевое слово `Then`:
```
If условие Then
  команды
EndIf
```

## Метод отладки: поэтапное усложнение

Проблема была найдена методом постепенного добавления функционала:

1. **Минимальная функция** - работает:
   ```
   Func
   :Return 1
   :EndFunc
   ```

2. **Добавление переменных** - работает:
   ```
   Func
   :Local n
   :colDim(a)→n
   :Return n
   :EndFunc
   ```

3. **Добавление цикла For** - работает:
   ```
   Func
   :Local n,r,i,s
   :colDim(a)→n
   :rowDim(a)→r
   :0→s
   :For i,1,r
   :s+a[i,1]→s
   :EndFor
   :Return s
   :EndFunc
   ```

4. **Добавление If БЕЗ Then** - НЕ РАБОТАЕТ (функция исчезает из библиотеки)

5. **Добавление If С Then** - РАБОТАЕТ!

## XML-экранирование операторов

При использовании операторов сравнения в XML необходимо экранирование:

| Оператор | XML-код | Использование |
|----------|---------|---------------|
| `<`      | `&lt;`  | Меньше |
| `>`      | `&gt;`  | Больше |
| `<=`     | `&lt;=` | Меньше или равно |
| `>=`     | `&gt;=` | Больше или равно |
| `&`      | `&amp;` | Конкатенация строк |

## Структура условных конструкций

### Простой If-Then-EndIf

```
If условие Then
:команды
:EndIf
```

### If-Then-Else-EndIf

```
If условие Then
:команды_если_истина
:Else
:команды_если_ложь
:EndIf
```

### Вложенный If (из примеров econ)

```
If dim(list1)≠dim(list2) Then
: Return undef
:EndIf
```

## Типы объектов в библиотеке

### Функции (Func...EndFunc)

- Атрибут `t="6"` в XML
- Используются для вычислений
- Возвращают значение через `Return`
- **НЕ МОГУТ** использовать `Disp` для вывода
- Пример: `is_productive(a)`

### Программы (Prgm...EndPrgm)

- Атрибут `t="7"` в XML
- Используются для сложных вычислений с выводом
- **МОГУТ** использовать `Disp` для вывода
- Пример: `check_prod(a)`

## Команды вывода (только в Prgm)

### Disp - вывод значений

```
Disp "текст"                  © Вывод строки
Disp переменная               © Вывод значения
Disp "текст", переменная      © Комбинированный вывод
Disp матрица                  © Вывод матрицы
```

### dispstring - динамический вывод (из примера linalg)

```
Func
:  expr("disp """&st&"""")
:  st
:EndFunc
```

## Вложенные циклы

Вложенные циклы `For` работают корректно:

```
For j,1,n
:0→s
:For i,1,r
:s+a[i,j]→s
:EndFor
:If s>=1 Then
:Return 0
:EndIf
:EndFor
```

## Проверка работы библиотеки

### Признаки НЕРАБОТАЮЩЕЙ библиотеки:

1. Файл `.tns` создается, но библиотека не появляется в списке после Refresh Libraries
2. Библиотека появляется, но отображается не все функции (только `version()`)
3. При вызове функции: "Library document not found"

### Признаки РАБОТАЮЩЕЙ библиотеки:

1. После Refresh Libraries библиотека появляется в Catalog
2. Все публичные функции (f="65536") отображаются в списке
3. Функции вызываются и возвращают корректные значения

## Рекомендации

1. **ВСЕГДА** используйте `Then` после `If`
2. Тестируйте функции поэтапно, от простого к сложному
3. Изучайте рабочие примеры в `examples/`
4. Используйте XML-экранирование для операторов сравнения
5. Для вывода используйте `Prgm`, для вычислений - `Func`
6. Проверяйте библиотеку после каждого значимого изменения

## Источники примеров

- `examples/linalg/Problem.xml` - сложные программы с выводом
- `src/Problem1.xml` (econ) - простые функции с проверками
- `delta.md` - базовые правила форматирования
