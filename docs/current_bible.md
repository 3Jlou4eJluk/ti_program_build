# TI-Nspire Library Development Bible

Полное руководство по разработке библиотек для TI-Nspire на TI-BASIC.

**Последнее обновление:** 2025-10-20
**Версия:** 1.0
**Основано на:** delta.md, delta2.md, delta3.md, delta4.md

---

## Оглавление

1. [Золотые правила](#золотые-правила)
2. [Формат XML](#формат-xml)
3. [Синтаксис TI-BASIC](#синтаксис-ti-basic)
4. [Переменные и область видимости](#переменные-и-область-видимости)
5. [Условия и циклы](#условия-и-циклы)
6. [Функции vs Программы](#функции-vs-программы)
7. [Матричные операции](#матричные-операции)
8. [Методология разработки](#методология-разработки)
9. [Отладка](#отладка)
10. [Контрольные списки](#контрольные-списки)
11. [Частые ошибки](#частые-ошибки)

---

## Золотые правила

### Правило #0: Не доверяйте компилятору
Luna НЕ выявляет синтаксические ошибки TI-BASIC. Код может скомпилироваться успешно, но функция не появится на калькуляторе.

### Правило #1: Инкрементальная разработка ВСЕГДА
- Добавляйте 5-20 строк за раз
- Компилируйте после каждого добавления
- Тестируйте на калькуляторе
- Если функция пропала → откат

### Правило #2: Копируйте формат из работающих примеров
Не следуйте официальным гайдам. Копируйте точный формат из `examples/`.

### Правило #3: Никаких комментариев
- ❌ XML: `<!-- comment -->`
- ❌ TI-BASIC: `:©comment`

Все комментарии удалить перед сборкой.

### Правило #4: If ВСЕГДА с Then
```
If condition Then     ✅ ПРАВИЛЬНО
  commands
EndIf

If condition          ❌ НЕПРАВИЛЬНО - функция не появится
  commands
EndIf
```

---

## Формат XML

### Document.xml — СТАРЫЙ формат

**❌ НЕ РАБОТАЕТ** (новый формат):
```xml
<?xml version="1.0" encoding="UTF-8"?>
<document xmlns="urn:TI.Document" ver="1.0">
  <product>TI-Nspire</product>
  ...
</document>
```

**✅ РАБОТАЕТ** (старый формат, одна строка):
```xml
<?xml version="1.0" encoding="UTF-8" ?><doc ver="1.0"><settings><assessmentMode>0</assessmentMode><devapd>0</devapd>...</settings><nps>1</nps></doc>
```

### Problem1.xml — Всё в ОДНУ строку

**❌ НЕ РАБОТАЕТ** (с переносами):
```xml
<?xml version="1.0" encoding="UTF-8"?>
<prob xmlns="urn:TI.Problem" ver="1.0">
  <sym>
    <e t="6" f="65536">
      <n>function_name</n>
      ...
    </e>
  </sym>
</prob>
```

**✅ РАБОТАЕТ** (одна строка):
```xml
<?xml version="1.0" encoding="UTF-8" ?><prob xmlns="urn:TI.Problem" ver="1.0"><sym><e t="6" f="65536"><n>function_name</n><p>param1,param2</p><v>Func&#13;:Local x&#13;:Return x&#13;:EndFunc</v></e></sym></prob>
```

### Атрибуты элементов

```xml
<e t="6" f="65536" c="0">   <!-- Публичная Function -->
<e t="6" f="196608" c="0">  <!-- Приватная Function (LibPriv) -->
<e t="7" f="65536" c="0">   <!-- Публичная Program -->
<e t="7" f="196608" c="0">  <!-- Приватная Program -->
```

- `t="6"` — Function (Func...EndFunc)
- `t="7"` — Program (Prgm...EndPrgm)
- `f="65536"` — публичная (LibPub)
- `f="196608"` — приватная (LibPriv)
- `c="0"` — **ОБЯЗАТЕЛЬНЫЙ атрибут**

### Переносы строк

**ТОЛЬКО** `&#13;` (carriage return):

```xml
<v>Func&#13;:Local i,s&#13;:0→s&#13;:Return s&#13;:EndFunc</v>
```

❌ НЕ используйте обычные переносы в XML.

### XML-экранирование операторов

| Оператор | XML-код | Пример |
|----------|---------|--------|
| `<` | `&lt;` | `If x&lt;5 Then` |
| `>` | `&gt;` | `If x&gt;10 Then` |
| `<=` | `&lt;=` | `If x&lt;=0 Then` |
| `>=` | `&gt;=` | `If x&gt;=1 Then` |
| `&` | `&amp;` | `"text"&amp;string(x)` |

---

## Синтаксис TI-BASIC

### Присваивание

**В Function:**
```
:= или →           ✅ оба работают
```

**В Program:**
```
→                  ✅ ТОЛЬКО стрелка
:=                 ❌ ОШИБКА в Prgm
```

**Примеры:**
```
:dim(list)→n       ✅ правильно
:dim(list):=n      ❌ ошибка в Prgm
```

### Строковая конкатенация

```
"text"&string(j)          ✅ использовать &
"text"+string(j)          ❌ + не работает для строк
```

### Команды вывода

```
:Disp "текст"                 вывод строки
:Disp variable                вывод значения
:Disp "text",var              комбинированный вывод
:Disp matrix                  вывод матрицы
```

**Важно:** `Disp` работает ТОЛЬКО в Program (Prgm), НЕ в Function (Func).

### Pause — НЕ ИСПОЛЬЗОВАТЬ

```
:Pause               ❌ вызывает ошибку компиляции
```

**Обход:**
```
:Disp " "
:Disp "Press ENTER to continue"
```

Калькулятор автоматически останавливается при `Disp`.

---

## Переменные и область видимости

### Объявление локальных переменных

**В начале функции:**
```
Func
:Local m,n,i,j,k,val
:...
:EndFunc
```

### Правило #7: Явное объявление в циклах

**Проблема:**
Переменная, объявленная в начале, может конфликтовать при повторном использовании.

**✅ Решение:**
Объявляйте `Local variable` непосредственно перед использованием в новом контексте:

```
Func
:Local m,n,i,j
:...
:For j,1,n
:  0→val
:  Local frac           ← явное объявление
:  val-floor(val)→frac
:  If frac>0.01 Then
:    Disp "fractional"
:  EndIf
:EndFor
:EndFunc
```

**❌ Неправильно:**
```
Func
:Local frac            ← объявлено в начале
:...
:... 100 строк ...
:Local cnt,frac        ← повторное объявление
:...
:For j,1,n
:  val-floor(val)→frac   ← использование без Local
:EndFor
:EndFunc
```

---

## Условия и циклы

### If-Then-EndIf (ОБЯЗАТЕЛЬНО Then!)

**✅ Правильно:**
```
:If condition Then
:  commands
:EndIf
```

**❌ НЕПРАВИЛЬНО (функция не появится):**
```
:If condition
:  commands
:EndIf
```

### If-Then-Else-EndIf

```
:If condition Then
:  commands_if_true
:Else
:  commands_if_false
:EndIf
```

### Примеры с экранированием

```xml
If s&gt;=1 Then&#13;:Return 0&#13;:EndIf
If dim(a)≠dim(b) Then&#13;:Return undef&#13;:EndIf
```

### For-цикл

```
:For i,1,n
:  commands
:EndFor

:For i,1,n,2          с шагом 2
:  commands
:EndFor
```

### While-цикл

```
:While not done and iter<20
:  commands
:EndWhile
```

### Вложенные циклы

Работают корректно:

```
:For j,1,n
:  0→s
:  For i,1,r
:    s+a[i,j]→s
:  EndFor
:  If s>=1 Then
:    Return 0
:  EndIf
:EndFor
```

---

## Функции vs Программы

### Function (Func...EndFunc)

```xml
<e t="6" f="65536" c="0">
  <n>function_name</n>
  <p>param1,param2</p>
  <v>Func&#13;:Local x&#13;:Return x&#13;:EndFunc</v>
</e>
```

**Характеристики:**
- Используются для вычислений
- **ДОЛЖНЫ** возвращать значение через `Return`
- **НЕ МОГУТ** использовать `Disp`
- Вызов: `library\function_name(args)`

**Пример:**
```
Func
:Local sum,i
:0→sum
:For i,1,dim(list)
:  sum+list[i]→sum
:EndFor
:Return sum
:EndFunc
```

### Program (Prgm...EndPrgm)

```xml
<e t="7" f="65536" c="0">
  <n>program_name</n>
  <p>param1,param2</p>
  <v>Prgm&#13;:Disp "Hello"&#13;:EndPrgm</v>
</e>
```

**Характеристики:**
- Используются для сложных вычислений с выводом
- **МОГУТ** использовать `Disp` для вывода
- Вызов: `library\program_name(args)`

**Пример:**
```
Prgm
:Local a,i
:Disp "Matrix analysis:"
:For i,1,rowDim(a)
:  Disp "Row",i,":",a[i]
:EndFor
:EndPrgm
```

---

## Матричные операции

### Размеры матрицы

```
:rowDim(mat)→m        количество строк
:colDim(mat)→n        количество столбцов
```

### Создание матриц

```
:newMat(rows,cols)→mat      новая матрица
:identity(n)→e              единичная матрица
```

### Доступ к элементам

```
:mat[i,j]→val              получить элемент
:value→mat[i,j]            установить элемент
```

Индексы с **1**, не с 0!

### Подматрицы

```
:subMat(mat,row1,col1,row2,col2)→result
```

Границы **включительно**.

### Обращение матрицы

```
:mat^(-1)→inv
```

---

## Методология разработки

### Инкрементальная разработка (ОБЯЗАТЕЛЬНО!)

**Этапы:**

1. **v0.1 — Минимальная функция:**
   ```
   Func
   :Return 1
   :EndFunc
   ```
   Тест: ✅ работает

2. **v0.2 — Добавить переменные:**
   ```
   Func
   :Local n
   :colDim(a)→n
   :Return n
   :EndFunc
   ```
   Тест: ✅ работает

3. **v0.3 — Добавить цикл:**
   ```
   Func
   :Local n,i,s
   :colDim(a)→n
   :0→s
   :For i,1,n
   :  s+a[1,i]→s
   :EndFor
   :Return s
   :EndFunc
   ```
   Тест: ✅ работает

4. **v0.4 — Добавить условие:**
   ```
   ... предыдущий код ...
   :If s<0 Then
   :  Return undef
   :EndIf
   :Return s
   ```
   Тест: ❌ не работает → откат, исправление

### Правило #8: Добавлять по частям

При добавлении нового функционала:

1. ✅ Добавить header (минимум)
2. ✅ Собрать и протестировать
3. ✅ Добавить структуру (loop/if)
4. ✅ Собрать и протестировать
5. ✅ Добавить логику
6. ✅ Собрать и протестировать
7. ✅ Добавить вывод
8. ✅ Собрать и протестировать

**❌ НЕ добавляйте всё сразу**, даже если уверены!

### Монолитная vs Модульная структура

**Рекомендация:** Монолитная структура (весь код в одной функции).

**Почему:**
- Проще отлаживать
- Все переменные в одном scope
- Меньше синтаксических проблем

**Попытка модульности часто приводит к:**
- Функции не появляются
- Ошибки в подфункциях блокируют всю библиотеку

---

## Отладка

### Признаки НЕРАБОТАЮЩЕЙ библиотеки

1. ✅ Файл `.tns` создан
2. ❌ Библиотека не появляется после `Refresh Libraries`
3. ❌ Функция не отображается в каталоге
4. ❌ При вызове: **"Variable is not defined"**

**Причина:** Синтаксическая ошибка в коде (Luna не выявил).

### Признаки РАБОТАЮЩЕЙ библиотеки

1. ✅ После `Refresh Libraries` библиотека в Catalog
2. ✅ Все публичные функции отображаются
3. ✅ Функции вызываются корректно

### Диагностика через Disp

**Используйте для отладки:**
```
:Disp "DEBUG: pcol=",pcol
:Disp "DEBUG: prow=",prow
:Disp "DEBUG: tableau:"
:Disp tab
```

**Проверка условий:**
```
:If pcol=0 Then
:  Disp "DEBUG: No entering variable"
:EndIf
```

**Проверка размеров:**
```
:rowDim(tab)→m
:colDim(tab)→n
:Disp "Dimensions:",m,n
```

### Метод поиска ошибки

**Когда функция перестала работать:**

1. Откатиться к последней рабочей версии
2. Определить, что именно добавлялось
3. Разбить изменение на 3-5 маленьких шагов
4. Добавить шаг 1 → собрать → тестировать
5. Добавить шаг 2 → собрать → тестировать
6. Найти точный шаг с ошибкой
7. Анализировать ТОЛЬКО этот шаг:
   - Проверить `Then` после `If`
   - Проверить `→` вместо `:=` в Prgm
   - Проверить `&` для строк
   - Проверить XML-экранирование
   - Проверить локальные переменные

---

## Контрольные списки

### Перед компиляцией

- [ ] Все `If` имеют `Then`
- [ ] Присваивания в Prgm используют `→`, не `:=`
- [ ] Нет команд `Pause`
- [ ] Все строки в XML заканчиваются `&#13;`
- [ ] Атрибут `c="0"` присутствует
- [ ] Строковая конкатенация использует `&`, не `+`
- [ ] XML-экранирование: `&lt;`, `&gt;`, `&amp;`
- [ ] Никаких комментариев (ни XML, ни TI-BASIC)
- [ ] Document.xml в старом формате (одна строка)
- [ ] Problem1.xml в одну строку

### Команда сборки

```bash
./Luna/luna src/Document.xml src/Problem1.xml build/library_name.tns
```

### После компиляции

- [ ] Файл `.tns` создан в `build/`
- [ ] Скопирован в `/MyLib` на калькуляторе
- [ ] Выполнен **Ctrl+Home → Refresh Libraries**
- [ ] Библиотека появилась в Catalog
- [ ] Функция появилась в списке
- [ ] Тестовый вызов работает корректно

### Установка на калькулятор

1. Скопировать `build/library.tns` в `/MyLib`
2. **Ctrl+Home** → **Refresh Libraries**
3. Открыть документ в **Program Editor**
4. **Menu** → **Library Access** → **LibPub**
5. **Check syntax & store**

Функции появятся как `library\function_name()`.

---

## Частые ошибки

### 1. Забыли Then после If

```
If x>5              ❌ функция пропадёт
  Return 0
EndIf

If x>5 Then         ✅ правильно
  Return 0
EndIf
```

### 2. Использовали := в Prgm

```
Prgm
:dim(list):=n       ❌ синтаксическая ошибка
:EndPrgm

Prgm
:dim(list)→n        ✅ правильно
:EndPrgm
```

### 3. Забыли Local перед использованием в цикле

```
For j,1,n
  val-floor(val)→frac    ❌ может не работать
EndFor

For j,1,n
  Local frac             ✅ явное объявление
  val-floor(val)→frac
EndFor
```

### 4. Неправильное XML-экранирование

```xml
If x>5 Then         ❌ неправильный XML
If x&gt;5 Then     ✅ правильно
```

### 5. Переносы строк в XML

```xml
<v>Func
:Return 1
:EndFunc</v>        ❌ неправильно

<v>Func&#13;:Return 1&#13;:EndFunc</v>    ✅ правильно
```

### 6. Использование Pause

```
:Pause              ❌ не работает
```

### 7. Комментарии в коде

```
<!-- comment -->    ❌ удалить
:©comment           ❌ удалить
```

### 8. Забыли атрибут c="0"

```xml
<e t="6" f="65536">           ❌ может не работать
<e t="6" f="65536" c="0">     ✅ правильно
```

### 9. Неправильные индексы матрицы

```
:mat[0,0]           ❌ индексы с 1!
:mat[1,1]           ✅ правильно
```

### 10. Использовали + для строк

```
:"x"+string(j)      ❌ не работает
:"x"&string(j)      ✅ правильно
```

---

## Примеры структур

### Минимальная Function

```xml
<e t="6" f="65536" c="0">
  <n>test_func</n>
  <p>x</p>
  <v>Func&#13;:Return x+1&#13;:EndFunc</v>
</e>
```

### Function с циклом

```xml
<e t="6" f="65536" c="0">
  <n>sum_list</n>
  <p>lst</p>
  <v>Func&#13;:Local i,s&#13;:0→s&#13;:For i,1,dim(lst)&#13;:s+lst[i]→s&#13;:EndFor&#13;:Return s&#13;:EndFunc</v>
</e>
```

### Program с выводом

```xml
<e t="7" f="65536" c="0">
  <n>display_matrix</n>
  <p>mat</p>
  <v>Prgm&#13;:Local i,r&#13;:rowDim(mat)→r&#13;:Disp "Matrix:"&#13;:For i,1,r&#13;:Disp "Row "&amp;string(i),mat[i]&#13;:EndFor&#13;:EndPrgm</v>
</e>
```

### Function с проверкой

```xml
<e t="6" f="65536" c="0">
  <n>safe_divide</n>
  <p>a,b</p>
  <v>Func&#13;:If abs(b)&lt;0.0001 Then&#13;:Return undef&#13;:EndIf&#13;:Return a/b&#13;:EndFunc</v>
</e>
```

---

## Рекомендации по производительности

### Ограничения итераций

```
:While not done and iter<20      макс. 20 итераций
```

**Можно увеличить**, но помните:
- Маленькие задачи (3-5 переменных): 10-30 секунд
- Большие задачи: несколько минут

### Точность вычислений

**Проблема:** Floating-point ошибки округления

**Решение:**
```
:If abs(val)>0.0001 Then        вместо =0
:If abs(val-1)<0.0001 Then      вместо =1
:If frac>0.0001 and frac<0.9999 избегать границ
```

---

## Источники и примеры

### Рабочие примеры в репозитории

- `examples/linalg/Problem.xml` — сложные программы с выводом
- `examples/econ/Problem1.xml` — простые функции с проверками
- Ваши собственные библиотеки после отладки

### Документация ошибок

- `docs/delta.md` — базовые правила форматирования
- `docs/delta2.md` — отладка leontief (If-Then)
- `docs/delta3.md` — проблемы gomory v0.1-v2.2.1
- `docs/delta4.md` — локальные переменные в циклах

---

## Быстрый старт

### 1. Создайте минимальную функцию

**Problem1.xml:**
```xml
<?xml version="1.0" encoding="UTF-8" ?><prob xmlns="urn:TI.Problem" ver="1.0"><sym><e t="6" f="65536" c="0"><n>test</n><p></p><v>Func&#13;:Return 42&#13;:EndFunc</v></e></sym></prob>
```

### 2. Скопируйте Document.xml из примеров

```bash
cp examples/econ/Document.xml src/
```

### 3. Соберите

```bash
./Luna/luna src/Document.xml src/Problem1.xml build/test.tns
```

### 4. Установите

- Скопируйте `build/test.tns` в `/MyLib`
- Ctrl+Home → Refresh Libraries

### 5. Тестируйте

```
test\test()
→ 42
```

### 6. Расширяйте инкрементально

Добавляйте функционал по 5-20 строк, тестируя после каждого изменения.

---

## Заключение

**Три кита разработки для TI-Nspire:**

1. **Инкрементальная разработка** — добавляйте код маленькими порциями
2. **Тестирование после каждого изменения** — не накапливайте изменения
3. **Точное следование формату** — копируйте из работающих примеров

**Помните:**
- Компилятор вам не друг (не выявляет ошибки)
- Калькулятор — единственный валидатор
- Терпение и методичность важнее скорости

**Если функция пропала — откат и инкрементально!**

---

**Версия:** 1.0
**Дата:** 2025-10-20
**Автор:** Собрано из опыта разработки библиотек econ, leontief, gomory
**Статус:** Проверено на практике
