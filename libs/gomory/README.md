# Библиотека gomory v2.0 для TI-Nspire

Библиотека для решения задач целочисленного и смешанного линейного программирования методом Гомори с двухфазным симплексом и пошаговым выводом.

## Файлы

- `build/gomory.tns` - готовая библиотека для калькулятора
- `libs/gomory/Document.xml` - конфигурационный файл
- `libs/gomory/Problem1.xml` - код программ и функций

## Установка на калькулятор

1. Скопировать `build/gomory.tns` в папку `/MyLib` на калькуляторе
2. Нажать **Ctrl+Home** → **Refresh Libraries**
3. Функции доступны в Catalog как `gomory\function_name()`

## Функции

### `gomory\gomory(mat, opt, intvars, ctypes)`

Решает задачу целочисленного и смешанного линейного программирования методом отсечений Гомори с двухфазным симплексом и пошаговым выводом.

**Параметры:**
- `mat` - объединённая матрица ((m+1)×(n+1)), где:
  - Строки 1..m, столбцы 1..n: матрица A (коэффициенты ограничений)
  - Строки 1..m, столбец n+1: вектор b (правые части)
  - Строка m+1, столбцы 1..n: вектор c^T (коэффициенты целевой функции)
  - Элемент mat[m+1,n+1]: игнорируется (можно 0)
- `opt` - 1 для max, 0 для min
- `intvars` - вектор-строка флагов целочисленности размера 1×n (1 = целое, 0 = любое)
- `ctypes` - вектор-строка типов ограничений размера 1×m:
  - 1 = ≤ (добавляет slack-переменную)
  - -1 = ≥ (добавляет surplus + artificial переменные)
  - 0 = = (добавляет artificial переменную)

**Возвращает:**
Пошаговое решение с выводом:
1. Phase 1 (если есть ограничения ≥ или =): минимизация искусственных переменных
2. Phase 2: оптимизация исходной целевой функции
3. Отсечений Гомори с дробными частями и формулами
4. Двойственного симплекса после каждого отсечения
5. Финального целочисленного решения

**Пример:**

Задача:
```
Максимизировать: Z = x₁ + x₂ + 5x₃
Ограничения:
  2x₁ + 3x₂ + 3x₃ ≤ 8
  x₁  + 4x₂ + 2x₃ ≤ 7
  x₁, x₂, x₃ ≥ 0, целые
```

Вызов:
```
gomory\gomory([[2,3,3,8][1,4,2,7][1,1,5,0]], 1, [1,1,1], [1,1])
```

**Формат матрицы:**
```
mat = [  2  3  3 | 8  ]  ← строка 1: a₁₁ a₁₂ a₁₃ | b₁
      [  1  4  2 | 7  ]  ← строка 2: a₂₁ a₂₂ a₂₃ | b₂
      [  1  1  5 | 0  ]  ← строка 3: c₁  c₂  c₃  | 0
        ↑  ↑  ↑          коэффициенты целевой функции
```

**Вывод:**
```
=== GOMORY INTEGER PROGRAMMING ===

Input validated
Objective: max
Variables: 3
Constraints: 2

[ENTER] - continue

Canonical form created

[ENTER] - continue

=== ITERATION 1 ===

Tableau:
x4 | [2 3 3 1 0 8]
x5 | [1 4 2 0 1 7]
Z  | [-1 -1 -5 0 0 0]

Entering var: x3
Leaving var: x4
Pivot: row 1 col 3
Pivot element: 3

[ENTER] - continue

...

=== OPTIMAL INTEGER SOLUTION ===

x1 = 1
x2 = 0
x3 = 2

Z = 11
```

**Правильный ответ:** x = (1, 0, 2), Z = 11

### `gomory\version()`

Возвращает версию библиотеки.

**Пример:**
```
gomory\version()
→ "2.0.0"
```

### `gomory\help()`

Выводит справку по использованию библиотеки.

**Пример:**
```
gomory\help()
```

## Алгоритм

### 1. Приведение к каноническому виду
- Добавляет slack-переменные для неравенств `≤`
- Формирует расширенную симплекс-таблицу
- Инициализирует базисное решение

### 2. Симплекс-метод
**На каждой итерации:**
- Вывод текущей таблицы
- Поиск ведущего столбца (min отрицательный коэффициент в Z-строке)
- Поиск ведущей строки (min положительное отношение b/a)
- Пивотирование
- Проверка оптимальности

**Стоп:** все коэффициенты Z-строки ≥ 0

### 3. Проверка целочисленности
Для каждой переменной xi, где intvars[i] = 1:
- Вычисляет дробную часть: f = xi - floor(xi)
- Если f > ε → требуется отсечение

### 4. Отсечение Гомори
**Пошаговый вывод:**
1. Выбор строки с максимальной дробной частью
2. Исходное равенство из таблицы
3. Вычисление дробных частей всех коэффициентов
4. Формула отсечения: Σ(-fⱼ)xⱼ ≤ -f₀
5. Добавление новой строки в таблицу

### 5. Двойственный симплекс
**Пока есть отрицательные b:**
- Ведущая строка: min b < 0
- Ведущий столбец: min |cⱼ/aⱼ| для aⱼ < 0
- Пивотирование
- Возврат к проверке целочисленности

### 6. Финальное решение
**Вывод:**
- Значения всех переменных
- Значение целевой функции Z
- Количество итераций и отсечений

## Внутренние функции (приватные)

- **ginput(...)** - валидация входных данных
- **ginit(...)** - инициализация симплекс-таблицы
- **gsimplex()** - симплекс-метод
- **gcheck_int()** - проверка целочисленности
- **gcut()** - построение отсечения Гомори
- **gdualsim()** - двойственный симплекс
- **gprint_tab()** - вывод таблицы
- **gpivot(row, col)** - пивотирование
- **gfrac(x)** - дробная часть числа
- **gisint(x)** - проверка целочисленности числа

## Внутренние переменные

- **θtab** - текущая симплекс-таблица
- **θbasis** - список базисных переменных
- **θiter** - счетчик итераций
- **θnvar** - количество переменных
- **θnconstr** - количество ограничений
- **θintvars** - флаги целочисленности
- **θintok** - флаг целочисленности решения

## Пересборка

```bash
./scripts/build.sh gomory
```

## Примечания

1. **Формат входных данных:**
   - Матрицы и векторы вводятся в формате TI-Nspire: `[[1,2][3,4]]`
   - Векторы-столбцы: `[[1][2][3]]`
   - Строка opt: обязательно в кавычках "max" или "min"

2. **Ограничения:**
   - Поддерживаются все типы ограничений: ≤, ≥, =
   - Все переменные должны быть неотрицательными
   - Максимум 20 отсечений Гомори
   - Отрицательные правые части автоматически нормализуются

3. **Производительность:**
   - Для задач 3-5 переменных: ~10-30 секунд
   - Для больших задач может требоваться больше времени

4. **Паузы:**
   - Между итерациями - нажмите [ENTER] для продолжения
   - Это позволяет изучить каждый шаг алгоритма

## Теория

**Метод отсечений Гомори** решает задачи целочисленного линейного программирования путем:
1. Решения релаксированной задачи симплекс-методом
2. Если решение нецелое - добавления отсечения (constraint)
3. Решения новой задачи двойственным симплексом
4. Повтора до получения целочисленного решения

**Отсечение Гомори:** для строки с дробным базисным значением:
```
Σ aⱼxⱼ = b
```
где b дробное, строим:
```
Σ (-frac(aⱼ))xⱼ ≤ -frac(b)
```
где frac(x) = x - floor(x) - дробная часть.

## Примеры задач

### Задача 1: Только ≤ ограничения
```
max Z = x₁ + x₂ + 5x₃
2x₁ + 3x₂ + 3x₃ ≤ 8
x₁ + 4x₂ + 2x₃ ≤ 7
x₁, x₂, x₃ ≥ 0, целые

gomory\gomory([[2,3,3,8][1,4,2,7][1,1,5,0]], 1, [1,1,1], [1,1])

Ответ: x=(1,0,2), Z=11
```

### Задача 2: С ограничениями =
```
max Z = 12x₁ + 7x₂
x₁ + 2x₂ + x₃ = 10
-x₁ - 2x₂ + x₄ = -2
2x₁ + x₂ + x₅ = 10
x₃, x₄, x₅ ≥ 0, целые; x₁, x₂ любые

gomory\gomory([[1,2,1,0,0,10][-1,-2,0,1,0,-2][2,1,0,0,1,10][12,7,0,0,0,0]], 1, [0,0,1,1,1], [0,0,0])

Ответ: x₁=10/3, x₂=10/3, x₃=0, x₄=8, x₅=0, Z=190/3
```

### Задача 3: Смешанные переменные с ≤
```
max Z = 3x₁ + 2x₂
x₁ + x₂ ≤ 4
2x₁ + x₂ ≤ 6
x₁ целое, x₂ любое

gomory\gomory([[1,1,4][2,1,6][3,2,0]], 1, [1,0], [1,1])
```

## Устранение неполадок

**Проблема:** "Library document not found"
- Решение: Убедитесь, что файл в `/MyLib` и выполнен Refresh Libraries

**Проблема:** "Error: A must be matrix"
- Решение: Проверьте формат входных данных, используйте двойные скобки

**Проблема:** "Max cuts reached"
- Решение: Задача может не иметь целочисленного решения или требует более 20 отсечений

**Проблема:** Программа зависла
- Решение: Нажмите [ON] для прерывания, проверьте корректность данных
